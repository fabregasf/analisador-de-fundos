{% extends 'base.html' %}
{% block title %}{{title}}{% endblock %}

{% block content %}
    <div class="container">
        <div class="chart row" style="max-width: 300px;
        max-height: 50px; text-align: center; margin-left: 40%;;">
            <span >Resultados encontrados: </span>
            
        </div> <br><br><br>
        <div class="row" id="graficos" >        
        </div>


    </div>
    
    <script>
        
        function processData(data)
        {
            const obj = JSON.parse(data['res']);
            plotCharts(obj);      
        }           
    
        $( document ).ready(function()
        {
            $.post('/pipe', function(data){
                processData(data);
                plotCharts(data);
            });
            

        });
        
        function plotCharts(data){
            console.log(data);
            var divmaior = document.getElementById('graficos');            
            
            for (var j = 0; j<data.length; j++) {
                var canvas = document.createElement("canvas");
                canvas.setAttribute("class","mychart");     
                ctx = canvas.getContext('2d');

                var colunas = document.createElement("div");
                colunas.setAttribute("class","col-md-4");   
                divmaior.append(colunas);
                colunas.append(canvas);

                // Ajuste nos caracteres dos dados
                data = format(data);
                
                var myChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: [data[j]['Tick'].substr(0,6)],
                        datasets: [ 
                                {
                                label: "Dividend Yield (ultimo)",
                                data: [data[j]["DyMes"]],
                                backgroundColor: [
                                    'rgba(0, 255, 120, 0.2)',
                                    'rgba(54, 162, 235, 0.2)',
                                    'rgba(255, 206, 86, 0.2)',
                                    'rgba(75, 192, 192, 0.2)',
                                    'rgba(153, 102, 255, 0.2)',
                                    'rgba(255, 159, 64, 0.2)'
                                ],
                                borderColor: [
                                    'rgba(0, 255, 120, 0.9)',
                                    'rgba(54, 162, 235, 0.2)',
                                    'rgba(255, 206, 86, 0.4)',
                                    'rgba(75, 192, 192, 0.2)',
                                    'rgba(153, 102, 255, 0.2)',
                                    'rgba(255, 159, 64, 0.2)'
                                ],
                                borderWidth: 1,
                                borderRadius: 2
                                },
                                {
                                label: "PVP (PreÃ§o sobre valor Patrimonial)",
                                data: [data[j]["pvp"]],
                                backgroundColor: [
                                    'rgba(255, 99, 132, 0.2)',
                                    'rgba(54, 162, 235, 0.2)',
                                    'rgba(255, 206, 86, 0.2)',
                                    'rgba(75, 192, 192, 0.2)',
                                    'rgba(153, 102, 255, 0.2)',
                                    'rgba(255, 159, 64, 0.2)'
                                ],
                                borderColor: [
                                    'rgba(255,99,132,1)',
                                    'rgba(54, 162, 235, 1)',
                                    'rgba(255, 206, 86, 1)',
                                    'rgba(75, 192, 192, 1)',
                                    'rgba(153, 102, 255, 1)',
                                    'rgba(255, 159, 64, 1)'
                                ],
                                borderWidth: 1,
                                borderRadius: 2}
                                // },
                                // {
                                // label: "EBITDA",
                                // data: [data[j]["ebitda"]],
                                // backgroundColor: [
                                //     'rgba(255, 99, 132, 0.2)',
                                //     'rgba(54, 162, 235, 0.2)',
                                //     'rgba(255, 206, 86, 0.2)',
                                //     'rgba(75, 192, 192, 0.2)',
                                //     'rgba(153, 102, 255, 0.2)',
                                //     'rgba(255, 159, 64, 0.2)'
                                // ],
                                // borderColor: [
                                //     'rgba(255,99,132,1)',
                                //     'rgba(54, 162, 235, 1)',
                                //     'rgba(255, 206, 86, 1)',
                                //     'rgba(75, 192, 192, 1)',
                                //     'rgba(153, 102, 255, 1)',
                                //     'rgba(255, 159, 64, 1)'
                                // ],
                                // borderWidth: 1,
                                // borderRadius: 2
                                // }
                            ]
                            },
                    options: {
                        indexAxis: 'x',
                        responsive: true,
                        scales: {
                            y: {
                                beginAtZero: true,
                                stepSize: 0.1
                            },
                            x: { 
                                stacked: false,
                                grid: {
                                    offset: true
                                }
                            }
                        }
                    }
                });               

            }
            
        }
        
        function format(data){

            for (var i = 0; i<data.length; i++) {
                data[i]['CotacaoBase'] = data[i]['CotacaoBase']
                .replace(",", ".")
                .replace("%", " ")
                .replace("R$", " ");                
                data[i]['DyMes'] = data[i]['DyMes']
                .replace(",", ".")
                .replace("%", "")
                .replace("R$", "");
                data[i]['pvp'] = data[i]['pvp']
                .replace(",", ".")
                .replace("%", " ")
                .replace("R$", "");

            }
            return data;
        }
       
    </script>

{% endblock %}